# Логирование активности для функционала друзей

## Обзор

В системе реализовано автоматическое логирование всех основных операций с друзьями. Каждое действие записывается в журнал активности пользователя и может быть использовано для аналитики, отображения истории действий и мониторинга системы.

## Логируемые события

### 1. FRIEND_REQUEST_SENT (Отправка запроса на дружбу)

**Маршрут:** `POST /api/friendship/request`

**Логируемые данные:**

```json
{
  "action": "FRIEND_REQUEST_SENT",
  "details": {
    "addresseeId": 123,
    "sentAt": "2025-06-25T12:00:00.000Z"
  }
}
```

**Описание:** Записывается, когда пользователь отправляет запрос на дружбу другому пользователю.

### 2. FRIEND_REQUEST_ACCEPTED (Принятие запроса на дружбу)

**Маршрут:** `PATCH /api/friendship/:friendshipId/accept`

**Логируемые данные:**

```json
{
  "action": "FRIEND_REQUEST_ACCEPTED",
  "details": {
    "friendshipId": 456,
    "acceptedAt": "2025-06-25T12:05:00.000Z"
  }
}
```

**Описание:** Записывается, когда пользователь принимает входящий запрос на дружбу.

### 3. FRIEND_REQUEST_DECLINED (Отклонение запроса на дружбу)

**Маршрут:** `PATCH /api/friendship/:friendshipId/decline`

**Логируемые данные:**

```json
{
  "action": "FRIEND_REQUEST_DECLINED",
  "details": {
    "friendshipId": 456,
    "declinedAt": "2025-06-25T12:03:00.000Z"
  }
}
```

**Описание:** Записывается, когда пользователь отклоняет входящий запрос на дружбу.

### 4. FRIEND_REMOVED (Удаление друга)

**Маршрут:** `DELETE /api/friendship/:friendshipId/remove`

**Логируемые данные:**

```json
{
  "action": "FRIEND_REMOVED",
  "details": {
    "friendshipId": 456,
    "removedAt": "2025-06-25T12:10:00.000Z"
  }
}
```

**Описание:** Записывается, когда пользователь удаляет друга или отменяет отправленный запрос.

## Дополнительное логирование

### 5. PRIVACY_CHANGE (Изменение настроек приватности)

**Маршрут:** `PUT /api/users/privacy`

**Логируемые данные:**

```json
{
  "action": "PRIVACY_CHANGE",
  "details": {
    "isPrivate": true,
    "changeTime": "2025-06-25T12:15:00.000Z"
  }
}
```

**Описание:** Записывается, когда пользователь изменяет настройки приватности своего профиля.

## Техническая реализация

### Middleware

Логирование активности реализовано через middleware `friendshipActivityMiddleware`, который автоматически добавляет записи в журнал активности при успешном выполнении операций.

### Файлы

- **Middleware:** `/middlewares/activityMiddleware.js`
- **Маршруты:** `/routes/friendshipRoutes.js`
- **Тесты:** `/tests/friendshipActivityTests.js`

### Условия логирования

Активность логируется только если:

1. Операция выполнена успешно (HTTP статус 200-299)
2. Пользователь авторизован
3. Нет ошибок в middleware

### Структура записи активности

Каждая запись в журнале активности содержит:

- `user_id` - ID пользователя, выполнившего действие
- `action` - тип действия (см. выше)
- `details` - дополнительные данные в формате JSON
- `ip_address` - IP адрес пользователя
- `user_agent` - User-Agent браузера
- `created_at` - временная метка

## Использование в интерфейсе

Записи активности можно получить через API:

```bash
GET /api/activity
```

Это позволяет отображать историю действий пользователя во вкладке "История" в профиле.

## Тестирование

Для проверки логирования активности используйте:

```bash
node tests/friendshipActivityTests.js
```

Тест проверяет все основные операции с друзьями и корректность записи активности.
