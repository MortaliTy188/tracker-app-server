<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tracker App - –ß–∞—Ç –î–µ–º–æ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chat-container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        width: 90%;
        max-width: 800px;
        height: 80vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        text-align: center;
        position: relative;
      }

      .chat-header h1 {
        font-size: 24px;
        margin-bottom: 5px;
      }

      .chat-header .subtitle {
        font-size: 14px;
        opacity: 0.9;
      }

      .status {
        position: absolute;
        top: 20px;
        right: 20px;
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        background: rgba(255, 255, 255, 0.2);
      }

      .status.connected {
        background: rgba(76, 175, 80, 0.8);
      }

      .auth-section {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .auth-section input {
        flex: 1;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 25px;
        font-size: 16px;
        outline: none;
        transition: border-color 0.3s;
      }

      .auth-section input:focus {
        border-color: #667eea;
      }

      .auth-section button {
        padding: 10px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        transition: transform 0.2s;
      }

      .auth-section button:hover {
        transform: translateY(-2px);
      }

      .auth-section button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .messages-container {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f8f9fa;
      }

      .message {
        margin-bottom: 15px;
        padding: 12px 16px;
        border-radius: 18px;
        max-width: 70%;
        word-wrap: break-word;
        animation: fadeIn 0.3s ease-in;
      }

      .message.sent {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
        text-align: right;
      }

      .message.received {
        background: white;
        color: #333;
        border: 1px solid #e1e5e9;
      }

      .message .sender {
        font-size: 12px;
        opacity: 0.7;
        margin-bottom: 4px;
      }

      .message .timestamp {
        font-size: 10px;
        opacity: 0.6;
        margin-top: 4px;
      }

      .typing-indicator {
        padding: 10px 20px;
        font-style: italic;
        color: #666;
        font-size: 14px;
      }

      .input-section {
        padding: 20px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .input-section input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #ddd;
        border-radius: 25px;
        font-size: 16px;
        outline: none;
        transition: border-color 0.3s;
      }

      .input-section input:focus {
        border-color: #667eea;
      }

      .input-section button {
        padding: 12px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        transition: transform 0.2s;
      }

      .input-section button:hover {
        transform: translateY(-2px);
      }

      .input-section button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .error {
        background: #ffebee;
        color: #c62828;
        padding: 10px;
        margin: 10px 20px;
        border-radius: 8px;
        border-left: 4px solid #c62828;
      }

      .success {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 10px;
        margin: 10px 20px;
        border-radius: 8px;
        border-left: 4px solid #2e7d32;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .user-info {
        font-size: 12px;
        padding: 5px 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        margin-left: 10px;
      }

      .chat-disabled {
        opacity: 0.5;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <div class="status" id="connectionStatus">–û—Ç–∫–ª—é—á–µ–Ω</div>
        <h1>üí¨ Tracker App Chat</h1>
        <div class="subtitle">–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —á–∞—Ç–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</div>
        <div class="user-info" id="userInfo" style="display: none"></div>
      </div>

      <div class="auth-section" id="authSection">
        <input
          type="text"
          id="userIdInput"
          placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à User ID (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1)"
        />
        <input
          type="text"
          id="otherUserIdInput"
          placeholder="User ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2)"
        />
        <button onclick="connectToChat()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
      </div>

      <div id="messagesContainer" class="messages-container">
        <div class="message received">
          <div class="sender">–°–∏—Å—Ç–µ–º–∞</div>
          <div>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –¥–µ–º–æ-—á–∞—Ç Tracker App! üéâ</div>
          <div>
            –î–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à User ID –∏ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞, –∑–∞—Ç–µ–º
            –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è".
          </div>
          <div class="timestamp">{–≤—Ä–µ–º—è}</div>
        </div>
      </div>

      <div
        class="typing-indicator"
        id="typingIndicator"
        style="display: none"
      ></div>

      <div class="input-section chat-disabled" id="inputSection">
        <input
          type="text"
          id="messageInput"
          placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
          onkeypress="handleKeyPress(event)"
        />
        <button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <script>
      let socket = null;
      let currentUserId = null;
      let otherUserId = null;
      let isTyping = false;
      let typingTimeout = null;

      // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
      const connectionStatus = document.getElementById("connectionStatus");
      const userInfo = document.getElementById("userInfo");
      const authSection = document.getElementById("authSection");
      const messagesContainer = document.getElementById("messagesContainer");
      const typingIndicator = document.getElementById("typingIndicator");
      const inputSection = document.getElementById("inputSection");
      const messageInput = document.getElementById("messageInput");

      // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —á–∞—Ç—É
      function connectToChat() {
        const userIdValue = document.getElementById("userIdInput").value.trim();
        const otherUserIdValue = document
          .getElementById("otherUserIdInput")
          .value.trim();

        if (!userIdValue || !otherUserIdValue) {
          showError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ–±–∞ User ID");
          return;
        }

        if (userIdValue === otherUserIdValue) {
          showError("User ID –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º–∏");
          return;
        }

        currentUserId = parseInt(userIdValue);
        otherUserId = parseInt(otherUserIdValue);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.IO (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Ç–æ–∫–µ–Ω –±–µ—Ä–µ—Ç—Å—è –∏–∑ localStorage)
        socket = io("http://localhost:3000", {
          auth: {
            token: "demo-token-user-" + currentUserId, // –î–µ–º–æ —Ç–æ–∫–µ–Ω
          },
        });

        setupSocketEvents();
      }

      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–±—ã—Ç–∏–π Socket.IO
      function setupSocketEvents() {
        socket.on("connect", () => {
          connectionStatus.textContent = "–ü–æ–¥–∫–ª—é—á–µ–Ω";
          connectionStatus.className = "status connected";
          userInfo.textContent = `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${currentUserId} ‚Üí ${otherUserId}`;
          userInfo.style.display = "block";
          authSection.style.display = "none";
          inputSection.classList.remove("chat-disabled");

          showSuccess("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!");

          // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ —á–∞—Ç—É
          socket.emit("join_chat", { otherUserId });
        });

        socket.on("disconnect", () => {
          connectionStatus.textContent = "–û—Ç–∫–ª—é—á–µ–Ω";
          connectionStatus.className = "status";
          inputSection.classList.add("chat-disabled");
        });

        socket.on("chat_joined", (data) => {
          showSuccess(`–ß–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${data.otherUserId} –æ—Ç–∫—Ä—ã—Ç`);
          loadMessages(); // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        });

        socket.on("new_message", (message) => {
          displayMessage(
            message,
            message.sender_id === currentUserId ? "sent" : "received"
          );
        });

        socket.on("user_typing", (data) => {
          if (data.userId !== currentUserId) {
            if (data.isTyping) {
              typingIndicator.textContent = `${data.userName} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
              typingIndicator.style.display = "block";
            } else {
              typingIndicator.style.display = "none";
            }
          }
        });

        socket.on("message_notification", (data) => {
          showNotification(
            `–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${data.senderName}: ${data.content}`
          );
        });

        socket.on("error", (error) => {
          showError(error.message);
        });

        socket.on("connect_error", (error) => {
          showError(
            "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –∏ –≤–∞—à User ID —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
          );
        });
      }

      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
      function sendMessage() {
        const content = messageInput.value.trim();
        if (!content || !socket) return;

        socket.emit("send_message", {
          receiverId: otherUserId,
          content: content,
          messageType: "text",
        });

        messageInput.value = "";
        stopTyping();
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à
      function handleKeyPress(event) {
        if (event.key === "Enter") {
          sendMessage();
        } else {
          startTyping();
        }
      }

      // –ù–∞—á–∞–ª–æ –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
      function startTyping() {
        if (!isTyping && socket) {
          isTyping = true;
          socket.emit("typing_start", { otherUserId });
        }

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(stopTyping, 2000);
      }

      // –û–∫–æ–Ω—á–∞–Ω–∏–µ –Ω–∞–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞
      function stopTyping() {
        if (isTyping && socket) {
          isTyping = false;
          socket.emit("typing_stop", { otherUserId });
        }
        clearTimeout(typingTimeout);
      }

      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      function displayMessage(message, type) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;

        const now = new Date();
        const timestamp = now.toLocaleTimeString("ru-RU", {
          hour: "2-digit",
          minute: "2-digit",
        });

        messageDiv.innerHTML = `
                <div class="sender">${
                  message.sender?.name || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å " + message.sender_id
                }</div>
                <div>${message.content}</div>
                <div class="timestamp">${timestamp}</div>
            `;

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (–∑–∞–≥–ª—É—à–∫–∞)
      function loadMessages() {
        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç API –∑–∞–ø—Ä–æ—Å
        const welcomeMessage = {
          sender_id: 0,
          sender: { name: "–°–∏—Å—Ç–µ–º–∞" },
          content: `–ß–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${otherUserId} –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!`,
        };
        displayMessage(welcomeMessage, "received");
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
      function showError(message) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.textContent = message;
        messagesContainer.appendChild(errorDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        setTimeout(() => {
          errorDiv.remove();
        }, 5000);
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ—Ö
      function showSuccess(message) {
        const successDiv = document.createElement("div");
        successDiv.className = "success";
        successDiv.textContent = message;
        messagesContainer.appendChild(successDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        setTimeout(() => {
          successDiv.remove();
        }, 3000);
      }

      // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      function showNotification(message) {
        if (Notification.permission === "granted") {
          new Notification("Tracker App Chat", {
            body: message,
            icon: "/favicon.ico",
          });
        }
      }

      // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
      }

      // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      document.addEventListener("DOMContentLoaded", () => {
        const timestamp = new Date().toLocaleTimeString("ru-RU", {
          hour: "2-digit",
          minute: "2-digit",
        });
        document.querySelector(".timestamp").textContent = timestamp;
      });
    </script>
  </body>
</html>
